#cloud-config
locale: en_US.UTF-8
timezone: Asia/Seoul

# í° ì—…ê·¸ë ˆì´ë“œë¡œ ë¶€íŒ… ì§€ì—°ì„ ë§‰ê¸° ìœ„í•´ upgradeëŠ” ë¹„í™œì„±í™”
package_update: true
package_upgrade: false

# íŒ¨í‚¤ì§€ ì„¤ì¹˜ëŠ” í•˜ì§€ ì•ŠìŒ(ì´ë¯¸ AMIì— ìˆë‹¤ê³  ê°€ì •). ì—†ì„ ê²½ìš° ìŠ¤í¬ë¦½íŠ¸ê°€ ê°ì§€í•˜ê³  ë©”ì‹œì§€ ì¶œë ¥.
packages: []

write_files:
  # ìŠ¤í¬ë¦½íŠ¸ (base64 ì‚½ì…)
  - path: /usr/local/bin/create_kratos_identity.sh
    permissions: '0755'
    encoding: b64
    content: "${kratos_script_b64}"

  - path: /usr/local/bin/create_hydra_client.sh
    permissions: '0755'
    encoding: b64
    content: "${hydra_script_b64}"

  # systemd units: ìˆœì„œ/ì˜ì¡´ì„± ë³´ì¥
  - path: /etc/systemd/system/kratos-provision.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Provision ORY Kratos Identity
      Wants=network-online.target
      After=network-online.target

      [Service]
      Type=oneshot
      Environment=kratos_admin_url=${kratos_admin_url}
      Environment=user_email=${user_email}
      Environment=user_name=${user_name}
      Environment=user_role=${user_role}
      ExecStart=/usr/local/bin/create_kratos_identity.sh
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/grafana-oidc.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Setup Hydra client and deploy Grafana
      Wants=network-online.target docker.service
      After=network-online.target docker.service kratos-provision.service

      [Service]
      Type=oneshot
      Environment=hydra_admin_url=${hydra_admin_url}
      Environment=hydra_public_url=${hydra_public_url}
      Environment=grafana_domain=${grafana_domain}
      Environment=grafana_client_id=${grafana_client_id}
      Environment=grafana_org_role=${grafana_org_role}
      ExecStart=/usr/local/bin/create_hydra_client.sh
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target

  - path: /etc/motd
    content: |
      ==========================================
      ğŸ” ORY Kratos Identity Autoâ€‘Provisioned
      ==========================================
      Email : ${user_email}
      Name  : ${user_name}
      Role  : ${user_role}

      Grafana OIDC configured via ORY Hydra.
      - Logs:
        * /var/log/kratos-provisioning.log
        * /var/log/grafana-oidc-setup.log
      - Grafana files:
        * /opt/grafana/docker-compose.yml
        * /opt/grafana/grafana.env (0600, contains client_secret)
      ==========================================

runcmd:
  # docker ê·¸ë£¹ ê¶Œí•œ ë¶€ì—¬ (ì¬ë¡œê·¸ì¸ í›„ ubuntu ì‚¬ìš©ìì— ë°˜ì˜)
  - [ bash, -lc, "usermod -aG docker ubuntu || true" ]
  - [ bash, -lc, "systemctl daemon-reload" ]
  - [ bash, -lc, "systemctl enable --now kratos-provision.service" ]
  - [ bash, -lc, "systemctl enable --now grafana-oidc.service" ]
