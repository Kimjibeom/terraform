#cloud-config
locale: en_US.UTF-8
timezone: Asia/Seoul

package_update: true
package_upgrade: true

packages:
  - git
  - curl
  - wget
  - htop
  - vim

runcmd:
  # --- Docker ê¶Œí•œ ë¶€ì—¬ (ubuntu ê³„ì •) ---
  - usermod -aG docker ubuntu

  # --- Docker ì‹œìž‘ ---
  - systemctl enable docker
  - systemctl start docker

  # --- Docker ì¤€ë¹„ ëŒ€ê¸° ---
  - |
    retries=10
    while ! docker info >/dev/null 2>&1 && [ $retries -gt 0 ]; do
      echo "Waiting for Docker to be ready..."
      sleep 3
      retries=$((retries - 1))
    done

  # --- ì›¹ì•± ë””ë ‰í† ë¦¬ ìƒì„± ---
  - mkdir -p /home/ubuntu/webapp
  - mkdir -p /home/ubuntu/webapp/postgres-data
  - mkdir -p /home/ubuntu/webapp/keycloak-data

  # --- Docker Compose ì„¤ì • (Keycloak + Postgres) ---
  #     KC_ADMIN_PW ëŠ” Compose ì‹¤í–‰ ì‹œ í™˜ê²½ë³€ìˆ˜ë¡œ ì „ë‹¬ë  ì˜ˆì •
  - |
    cat > /home/ubuntu/webapp/docker-compose.yml << 'EOF'
    version: '3'

    services:
      postgres:
        image: postgres:15
        container_name: keycloak-db
        environment:
          - POSTGRES_DB=keycloak
          - POSTGRES_USER=keycloak
          - POSTGRES_PASSWORD=keycloak_db_password
          - TZ=Asia/Seoul
        volumes:
          - ./postgres-data:/var/lib/postgresql/data
        ports:
          - "5432:5432"
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
          interval: 10s
          timeout: 5s
          retries: 5
        restart: unless-stopped

      keycloak:
        image: quay.io/keycloak/keycloak:latest
        container_name: keycloak-app
        command: start-dev
        depends_on:
          postgres:
            condition: service_healthy
        environment:
          - KEYCLOAK_ADMIN=${user_id}
          - KEYCLOAK_ADMIN_PASSWORD=$${KC_ADMIN_PW}
          - KC_DB=postgres
          - KC_DB_URL=jdbc:postgresql://postgres:5432/keycloak
          - KC_DB_USERNAME=keycloak
          - KC_DB_PASSWORD=keycloak_db_password
          - KC_HOSTNAME_STRICT=false
          - KC_HOSTNAME_STRICT_HTTPS=false
          - KC_HTTP_ENABLED=true
          - KC_PROXY=edge
          - KC_LOG_LEVEL=INFO
          - TZ=Asia/Seoul
        ports:
          - "8080:8080" 
        volumes:
          - ./keycloak-data:/opt/keycloak/data
        restart: unless-stopped
    EOF

  # --- ê¶Œí•œ ì„¤ì • ---
  - chown -R ubuntu:ubuntu /home/ubuntu/webapp
  - chmod -R 755 /home/ubuntu/webapp

  # --- ë™ì  ê´€ë¦¬ìž PW ìƒì„± & Compose ì‹¤í–‰ ---
  #     (runcmd í•­ëª© ê°„ í™˜ê²½ì´ ê³µìœ ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ í•œ ë¸”ë¡ì—ì„œ ì²˜ë¦¬)
  - |
    KC_ADMIN_PW="$(openssl rand -base64 24 | tr -dc 'A-Za-z0-9' | head -c 20)"
    echo -n "$KC_ADMIN_PW" > /root/kc_admin_pw
    chmod 600 /root/kc_admin_pw

    # Compose ì‹¤í–‰ (í™˜ê²½ë³€ìˆ˜ ì£¼ìž…)
    cd /home/ubuntu/webapp
    KC_ADMIN="${user_id}" KC_ADMIN_PW="$KC_ADMIN_PW" PATH=$PATH:/usr/local/bin:/usr/bin docker compose up -d

  # --- Keycloak ì¤€ë¹„ ëŒ€ê¸° ---
  - |
    echo "Waiting for Keycloak to be ready..."
    retries=30
    while [ $retries -gt 0 ]; do
      if curl -fs http://localhost:8080/health/ready >/dev/null 2>&1; then
        echo "Keycloak is ready!"
        break
      fi
      echo "Still waiting... ($retries left)"
      sleep 10
      retries=$((retries - 1))
    done

  # --- ìžê²© ì •ë³´ ì €ìž¥ ---
  - |
    KC_ADMIN_PW="$(cat /root/kc_admin_pw)"
    PUB_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
    cat > /home/ubuntu/credentials.txt << EOF
    ==========================================
    ðŸ” KEYCLOAK ADMIN CREDENTIALS
    ==========================================
    Admin ID     : ${user_id}
    Admin PW     : $${KC_ADMIN_PW}
    Instance ID  : $(curl -s http://169.254.169.254/latest/meta-data/instance-id)

    Keycloak Admin Console:
    - http://$PUB_IP:8080/admin/

    Generated at: $(date)
    ==========================================
    EOF
    chmod 600 /home/ubuntu/credentials.txt
    chown ubuntu:ubuntu /home/ubuntu/credentials.txt

final_message: |
  ==========================================
  âœ… KEYCLOAK + POSTGRES DEPLOYED
  ==========================================
  Admin ID: ${user_id}
  Password: (see /home/ubuntu/credentials.txt)
  Instance ID: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)

  ðŸ”— Admin Console:
  http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8080/admin/

  ðŸ“ Credentials: /home/ubuntu/credentials.txt
  ==========================================

write_files:
  - path: /etc/motd
    content: |
      ==========================================
      ðŸš€ Keycloak Authentication Server
      ==========================================
      Admin Console: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8080/admin/
      Credentials file: /home/ubuntu/credentials.txt
      ==========================================
